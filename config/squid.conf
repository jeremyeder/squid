# Squid Caching Proxy Configuration
# Purpose: Cache web content for Claude Code sessions
# Cache Strategy: Balanced (respect TTLs, reasonable freshness)

# === SSL Bumping Configuration ===
http_port 3128 ssl-bump \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB \
    cert=/etc/squid/certs/squid-ca.pem \
    key=/etc/squid/certs/squid-ca.key

# SSL bump all HTTPS traffic
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# === Cache Configuration ===
# 10GB disk cache, 16 first-level dirs, 256 second-level dirs
cache_dir ufs /var/spool/squid 10000 16 256

# Memory cache for hot objects
cache_mem 256 MB
maximum_object_size_in_memory 512 KB
maximum_object_size 100 MB
minimum_object_size 0 KB

# === Refresh Patterns (Balanced Strategy) ===
# Format: refresh_pattern regex min percent max

# HTML content: 1 hour to 24 hours
refresh_pattern -i \.html?$     60    20%   1440

# CSS/JS: 1 day to 7 days
refresh_pattern -i \.(css|js)$  1440  50%   10080

# Images: 7 days to 30 days
refresh_pattern -i \.(jpg|jpeg|png|gif|ico|webp)$ 10080 90% 43200

# Documentation sites (common for Claude Code)
refresh_pattern -i (docs\.|documentation\.) 1440 50% 10080

# API responses: 1 hour to 6 hours (may change frequently)
refresh_pattern -i (api\.|/api/) 60 20% 360

# Default: 1 hour to 3 days
refresh_pattern .               60    20%   4320

# === Access Control ===
acl localhost src 127.0.0.1/32 ::1
acl SSL_ports port 443
acl Safe_ports port 80 443
acl CONNECT method CONNECT

# Deny non-safe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost only
http_access allow localhost
http_access deny all

# === Cache Manager Access ===
cachemgr_passwd secretpassword all
cache_mgr jeder@redhat.com

# === Logging ===
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log daemon:/var/log/squid/store.log

# Log level (0=critical, 1=important, 2=debug)
debug_options ALL,1

# === Performance Tuning ===
# DNS cache
dns_nameservers 8.8.8.8 8.8.4.4
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# Connection limits
maximum_object_size 100 MB

# === Miscellaneous ===
coredump_dir /var/spool/squid
pid_filename /var/run/squid.pid
visible_hostname squid-proxy.local
